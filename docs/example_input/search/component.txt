import 'package:flutter/material.dart';

class AnimatedSearchBar extends StatefulWidget {
  final Function(String) onSubmitted;

  const AnimatedSearchBar({Key? key, required this.onSubmitted}) : super(key: key);

  @override
  _AnimatedSearchBarState createState() => _AnimatedSearchBarState();
}

class _AnimatedSearchBarState extends State<AnimatedSearchBar> {
  // Stan: czy pasek jest rozwinięty
  bool _isExpanded = false;
  
  // Kontrolery do tekstu i klawiatury
  late TextEditingController _textController;
  late FocusNode _focusNode;

  @override
  void initState() {
    super.initState();
    _textController = TextEditingController();
    _focusNode = FocusNode();
    
    // Opcjonalnie: Nasłuchuj zmian fokusa (np. zamknięcie klawiatury zamyka pasek)
    _focusNode.addListener(() {
      if (!_focusNode.hasFocus && _textController.text.isEmpty) {
        setState(() {
          _isExpanded = false;
        });
      }
    });
  }

  @override
  void dispose() {
    _textController.dispose();
    _focusNode.dispose();
    super.dispose();
  }

  // Główna funkcja sterująca otwieraniem/zamykaniem
  void _toggleSearch() {
    setState(() {
      _isExpanded = !_isExpanded;
    });

    if (_isExpanded) {
      // Jeśli otwieramy -> poproś o fokus (pokaż klawiaturę)
      _focusNode.requestFocus();
    } else {
      // Jeśli zamykamy -> schowaj klawiaturę i wyczyść tekst
      _focusNode.unfocus();
      _textController.clear();
    }
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      // Kliknięcie poza ikoną/polem nie robi nic tutaj, 
      // ale zapobiega propagacji tapnięć w dół drzewa widgetów
      onTap: () {}, 
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 375),
        curve: Curves.easeInOut, // Płynne przyspieszenie i zwolnienie
        
        // Zmiana szerokości: 50.0 to przycisk, 300.0 to pasek
        // Możesz użyć MediaQuery, aby dostosować to do ekranu
        width: _isExpanded ? 300.0 : 50.0, 
        height: 50.0,
        
        decoration: BoxDecoration(
          color: Colors.white,
          // Jeśli zwinięty: idealne koło (25.0). Jeśli rozwinięty: zaokrąglony prostokąt (30.0)
          borderRadius: BorderRadius.circular(_isExpanded ? 30.0 : 25.0),
          boxShadow: [
            BoxShadow(
              color: Colors.black26,
              blurRadius: 10.0,
              offset: const Offset(0, 5),
            ),
          ],
        ),
        child: Row(
          children: [
            // IKONA LUPY (Przycisk otwierania)
            Material(
              color: Colors.transparent,
              child: InkWell(
                borderRadius: BorderRadius.circular(25.0),
                onTap: _toggleSearch,
                child: const SizedBox(
                  width: 50.0,
                  height: 50.0,
                  child: Icon(Icons.search, color: Colors.blueGrey),
                ),
              ),
            ),
            
            // POLE TEKSTOWE
            Expanded(
              child: AnimatedOpacity(
                // Ukrywamy tekst szybciej niż zwija się pasek, by uniknąć glitchy
                duration: Duration(milliseconds: _isExpanded ? 300 : 200),
                opacity: _isExpanded ? 1.0 : 0.0,
                child: _isExpanded
                    ? TextField(
                        controller: _textController,
                        focusNode: _focusNode,
                        cursorColor: Colors.blueGrey,
                        decoration: const InputDecoration(
                          hintText: 'Szukaj...',
                          border: InputBorder.none,
                          contentPadding: EdgeInsets.symmetric(horizontal: 10),
                        ),
                        onSubmitted: (value) {
                          widget.onSubmitted(value);
                          _toggleSearch(); // Zamknij po wyszukaniu
                        },
                      )
                    : null, // Nie renderuj TextField, gdy zamknięte
              ),
            ),

            // PRZYCISK ZAMYKANIA (X)
            // Widoczny tylko, gdy pasek jest rozwinięty
            if (_isExpanded)
              Material(
                color: Colors.transparent,
                child: InkWell(
                  borderRadius: BorderRadius.circular(25.0),
                  onTap: _toggleSearch,
                  child: const SizedBox(
                    width: 50.0,
                    height: 50.0,
                    child: Icon(Icons.close, color: Colors.grey),
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }
}